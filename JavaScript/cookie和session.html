<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cookie 、 Session 和 Token | 略记一二</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="笔记记了是要常常翻出来看的，不然干嘛要花那么多时间记笔记？">
    <link rel="preload" href="/assets/css/0.styles.e11ec23d.css" as="style"><link rel="preload" href="/assets/js/app.e38833ea.js" as="script"><link rel="preload" href="/assets/js/2.17cbeac6.js" as="script"><link rel="preload" href="/assets/js/12.a9bf3862.js" as="script"><link rel="prefetch" href="/assets/js/10.250fcf81.js"><link rel="prefetch" href="/assets/js/11.f157cd0b.js"><link rel="prefetch" href="/assets/js/13.896ca89d.js"><link rel="prefetch" href="/assets/js/14.87494d07.js"><link rel="prefetch" href="/assets/js/15.f68977cd.js"><link rel="prefetch" href="/assets/js/16.b94738a9.js"><link rel="prefetch" href="/assets/js/17.e2c75320.js"><link rel="prefetch" href="/assets/js/18.771a5ec2.js"><link rel="prefetch" href="/assets/js/19.d49b8edf.js"><link rel="prefetch" href="/assets/js/20.555d276b.js"><link rel="prefetch" href="/assets/js/21.e44090be.js"><link rel="prefetch" href="/assets/js/22.097d6f98.js"><link rel="prefetch" href="/assets/js/23.4b3259b7.js"><link rel="prefetch" href="/assets/js/24.3c89c6ed.js"><link rel="prefetch" href="/assets/js/25.f67fd8aa.js"><link rel="prefetch" href="/assets/js/26.884593de.js"><link rel="prefetch" href="/assets/js/27.0564c2cb.js"><link rel="prefetch" href="/assets/js/28.e1a2c4d8.js"><link rel="prefetch" href="/assets/js/29.1ebfe2ec.js"><link rel="prefetch" href="/assets/js/3.dac61e26.js"><link rel="prefetch" href="/assets/js/30.8c4ee977.js"><link rel="prefetch" href="/assets/js/31.8986c831.js"><link rel="prefetch" href="/assets/js/32.4b30f57a.js"><link rel="prefetch" href="/assets/js/33.b9a4cf5e.js"><link rel="prefetch" href="/assets/js/34.776e490e.js"><link rel="prefetch" href="/assets/js/35.9bdcf90b.js"><link rel="prefetch" href="/assets/js/36.b5932fba.js"><link rel="prefetch" href="/assets/js/37.df17cf67.js"><link rel="prefetch" href="/assets/js/38.3d8b4eda.js"><link rel="prefetch" href="/assets/js/39.b3be75c3.js"><link rel="prefetch" href="/assets/js/4.b0dc7c39.js"><link rel="prefetch" href="/assets/js/40.96fd608f.js"><link rel="prefetch" href="/assets/js/41.0513a23b.js"><link rel="prefetch" href="/assets/js/42.6cd3cc53.js"><link rel="prefetch" href="/assets/js/43.5ef51692.js"><link rel="prefetch" href="/assets/js/44.794100ff.js"><link rel="prefetch" href="/assets/js/45.d10168fa.js"><link rel="prefetch" href="/assets/js/46.10688120.js"><link rel="prefetch" href="/assets/js/47.094c2cd3.js"><link rel="prefetch" href="/assets/js/48.95a26822.js"><link rel="prefetch" href="/assets/js/49.41c75b8f.js"><link rel="prefetch" href="/assets/js/5.c61e0a12.js"><link rel="prefetch" href="/assets/js/50.06594e41.js"><link rel="prefetch" href="/assets/js/51.4227a338.js"><link rel="prefetch" href="/assets/js/52.b756be3f.js"><link rel="prefetch" href="/assets/js/53.0d45f222.js"><link rel="prefetch" href="/assets/js/54.a37e137d.js"><link rel="prefetch" href="/assets/js/55.81a19fae.js"><link rel="prefetch" href="/assets/js/56.800ff698.js"><link rel="prefetch" href="/assets/js/57.70844d0c.js"><link rel="prefetch" href="/assets/js/58.f750a736.js"><link rel="prefetch" href="/assets/js/59.46a720cc.js"><link rel="prefetch" href="/assets/js/6.b167fa87.js"><link rel="prefetch" href="/assets/js/60.281e7077.js"><link rel="prefetch" href="/assets/js/61.03db5b64.js"><link rel="prefetch" href="/assets/js/62.3ef279a6.js"><link rel="prefetch" href="/assets/js/63.58d1689f.js"><link rel="prefetch" href="/assets/js/64.691b77a9.js"><link rel="prefetch" href="/assets/js/65.aea71ebe.js"><link rel="prefetch" href="/assets/js/66.fdcb5c4c.js"><link rel="prefetch" href="/assets/js/67.3851f01d.js"><link rel="prefetch" href="/assets/js/68.eff1c7f3.js"><link rel="prefetch" href="/assets/js/69.b97074c2.js"><link rel="prefetch" href="/assets/js/7.092eb31d.js"><link rel="prefetch" href="/assets/js/70.7525968a.js"><link rel="prefetch" href="/assets/js/71.fdc9d9ba.js"><link rel="prefetch" href="/assets/js/72.e699fc43.js"><link rel="prefetch" href="/assets/js/73.a075b568.js"><link rel="prefetch" href="/assets/js/74.ad5edd6a.js"><link rel="prefetch" href="/assets/js/75.fcf08968.js"><link rel="prefetch" href="/assets/js/76.0fcbd3a7.js"><link rel="prefetch" href="/assets/js/77.1b7c112c.js"><link rel="prefetch" href="/assets/js/78.0aa2e0c8.js"><link rel="prefetch" href="/assets/js/79.036605dc.js"><link rel="prefetch" href="/assets/js/8.6636c5ea.js"><link rel="prefetch" href="/assets/js/80.2c62bfcb.js"><link rel="prefetch" href="/assets/js/81.3c52e5ef.js"><link rel="prefetch" href="/assets/js/82.541ed7c1.js"><link rel="prefetch" href="/assets/js/83.db9e79cf.js"><link rel="prefetch" href="/assets/js/9.71cb8be9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e11ec23d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">略记一二</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://blog.dangosky.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/DangoSky" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://blog.dangosky.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/DangoSky" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaScript/其他.html" class="sidebar-link">其他</a></li><li><a href="/JavaScript/DOM属性计算.html" class="sidebar-link">DOM 属性计算</a></li><li><a href="/JavaScript/this.html" class="sidebar-link">this</a></li><li><a href="/JavaScript/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/JavaScript/Iterator和Generator.html" class="sidebar-link">Iterator 和 Generator</a></li><li><a href="/JavaScript/async.html" class="sidebar-link">async</a></li><li><a href="/JavaScript/网络.html" class="sidebar-link">网络</a></li><li><a href="/JavaScript/模块化.html" class="sidebar-link">模块化</a></li><li><a href="/JavaScript/Storage.html" class="sidebar-link">浏览器存储</a></li><li><a href="/JavaScript/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/JavaScript/内存管理.html" class="sidebar-link">内存管理</a></li><li><a href="/JavaScript/疑难杂症.html" class="sidebar-link">疑难杂症</a></li><li><a href="/JavaScript/WebSocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/JavaScript/OAuth.html" class="sidebar-link">OAuth</a></li><li><a href="/JavaScript/cookie和session.html" class="active sidebar-link">Cookie 、 Session 和 Token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/cookie和session.html#cookie" class="sidebar-link">Cookie</a></li><li class="sidebar-sub-header"><a href="/JavaScript/cookie和session.html#session" class="sidebar-link">Session</a></li><li class="sidebar-sub-header"><a href="/JavaScript/cookie和session.html#token" class="sidebar-link">Token</a></li><li class="sidebar-sub-header"><a href="/JavaScript/cookie和session.html#jwt" class="sidebar-link">JWT</a></li><li class="sidebar-sub-header"><a href="/JavaScript/cookie和session.html#sso-单点登录" class="sidebar-link">SSO 单点登录</a></li></ul></li><li><a href="/JavaScript/网页性能.html" class="sidebar-link">网页性能</a></li><li><a href="/JavaScript/小程序.html" class="sidebar-link">小程序</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React-Route</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mobx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cookie-、-session-和-token"><a href="#cookie-、-session-和-token" class="header-anchor">#</a> Cookie 、 Session 和 Token</h1> <h2 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h2> <blockquote><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies" target="_blank" rel="noopener noreferrer">HTTP cookies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5e718ecc6fb9a07cda098c2d" target="_blank" rel="noopener noreferrer">预测最近面试会考 Cookie 的 SameSite 属性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>HTTP 是无状态的协议。对于事务处理没有记忆能力，每次客户端和服务端会话完成时，服务端不会保存任何会话信息。可以通过 Cookie 或者 Session 来保存两者通信的状态。Cookie 存储在客户端，在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。</p> <h4 id="cookie-的属性"><a href="#cookie-的属性" class="header-anchor">#</a> Cookie 的属性</h4> <ul><li><p>Domain 和 Path：可以用来限制 Cookie 使用的域名和路径范围。Domain 的默认值为设置该 Cookie 的网页所在域名，Path 默认值为设置该 Cookie 的网页所在的目录。需要注意的是二级域名可以使用一级域名下的 Cookie。但如果是跨域请求，即使 Domain 和 Path 都满足，Cookie 也不会被添加到请求中。</p></li> <li><p>Secure：设置为 true 的话表示该 Cookie 只能在 https 中使用。需要注意的是通过 JavaScript 修改 Secure 属性时，必须保证网页是 https 协议的，在 http 协议的网页中是无法设置 Secure 类型的 Cookie的。</p></li> <li><p>HttpOnly：设置为 true 的话表示该 Cookie 只能在服务端访问，不能被 JavaScript 访问到。</p></li> <li><p>Expires/Max-age 属性：表示 Cookie 的有效时间（如果 Expires 和 Max-age 都存在的话，Max-age 优先级更高）。</p> <ul><li>Expires 是一个时间点表示 Cookie 失效的时刻，必须是 GMT 格式的时间，可以通过 <code>new Date().toGMTString()</code> 装换。默认值为 Session，表示有效期是到浏览器关闭的时候。</li> <li>Max-age 的值是一个以秒为单位的时间段，表示从现在开始多少秒后 Cookie 失效。Max-age 有三种可能值：负数、0、正数。负数表示会话级 Cookie（默认值是 -1）；0 表示立即删除 Cookie；正数表示有效期为创建时刻加上该 Max-age 值。</li></ul></li> <li><p>SameSite：控制在跨站请求时是否要发送 Cookie，可以用来防止 CSRF 攻击。之前默认值是 None，Chrome80 后默认是 Lax。它可以设置以下三个值：</p> <ul><li>Strict：跨站点时任何情况下都不会发送 Cookie。只有当前网页的 URL 与请求目标一致，才会带上 Cookie。比如访问 google.com，只有在 google.com 域名下的的请求才会携带上 Cookie。</li> <li>Lax：只有导航到目标网址的 Get 请求才允许发送 Cookie，其他的一律禁止。比如 a 链接、link 加载静态资源、GET 表单请求等。而 POST 请求、AJAX 请求、img 链接、iframe 链接等则禁止带上 Cookie。</li> <li>None：关闭 SameSite 属性，但同时要设置 Secure 属性，否则无效。</li> <li>（Samesite Cookie 目前有一个致命的缺陷：不支持子域。例如在 topic.a.com 下的 Cookie，并不能使用 a.com 下的 Samesite Cookie。</li></ul></li></ul> <h4 id="cookie-有效时间-faq"><a href="#cookie-有效时间-faq" class="header-anchor">#</a> Cookie 有效时间 FAQ</h4> <p>Cookie 的过期时间是相对于客户端时间而言的，设置的时间则是相对于服务器时间而言的，这里有两个问题：</p> <p>Q：如果服务器在海外，和国内的客户端相差了好几个小时，那么可能海外服务器下发 Cookie 到国内客户端的时候，因为时差 Cookie 就已经失效了。</p> <p>A：服务器下发 Cookie 的时候会指明时区。</p> <p>Q：客户端可以修改 Cookie 的有效期，让 Cookie 永久有效。</p> <p>A：请求时将 Cookie 发送到服务器，服务器会将这个 Cookie 的信息和服务器上对应的这个 Cookie 信息（也可以存在数据库里）做对比，有效的话才会验证通过。</p> <h4 id="设置-cookie"><a href="#设置-cookie" class="header-anchor">#</a> 设置 Cookie</h4> <ul><li>服务端通过响应头中的 <code>Set-cookie</code> 字段设置。</li> <li>客户端设置：
<ul><li><code>document.cookie = &quot;${name}=${value}; expires=Thu, 26 Feb 2116 11:50:25 GMT; domain=${domain}&quot;</code></li></ul></li> <li>注意如果在客户端修改 Cookie，新旧 Cookie 的 Domain 和 Path 属性需要保持一致，否则就成了设置新的 Cookie 了。</li> <li>最好对 Cookie 的键值使用 escape 和 unescape 进行编码解码，防止中间包含逗号、分号、空格而被当做特殊字符。</li></ul> <h2 id="session"><a href="#session" class="header-anchor">#</a> Session</h2> <p>Session 也是记录服务器和客户端会话状态的工具。</p> <h4 id="session-认证流程"><a href="#session-认证流程" class="header-anchor">#</a> Session 认证流程</h4> <ol><li>用户第一次请求服务器的时候，服务器创建对应的 Session 来保存用户信息，并把 Session 的唯一标识信息 SessionID 返回给客户端。</li> <li>客户端接收到服务器返回的 SessionID 信息后，会将此信息存入到 Cookie 中，同时 Cookie 记录此 SessionID 属于哪个域名。</li> <li>当客户端第二次访问服务器的时候，请求会自动判断此域名下是否存在 Cookie 信息，如果存在则自动将 Cookie 信息也发送给服务端。</li> <li>收到请求中的 SessionID 后，服务端会根据 SessionID 查找对应的 Session 信息，如果没有找到说明用户没有登录或者登录失效，如果找到 Session 证明用户已经登录可执行后面操作。</li></ol> <h4 id="session-的缺点"><a href="#session-的缺点" class="header-anchor">#</a> Session 的缺点</h4> <ul><li><p>扩展性不好。如果是服务器集群的话，就要求 Session 数据共享，使得每台服务器都能够读取到 Session（比如 A 网站和 B 网站是同一家公司的关联服务，现在要求用户只要在其中一个网站登录，再访问另一个网站就会自动登录）。然而 Session 信息难以同步，因为服务器之间并不共享 Seesion。</p> <ul><li>每台服务器上的 Session 发生改变后，就将其广播给其他的服务器。</li> <li>将 Session 集中存储在某台服务器上，验证时都将请求定向到该服务器上。</li> <li>将 Session 存储到数据库中，保证 Session 的持久化。</li></ul></li> <li><p>Session 存储在服务端，如果存储的数量太多，可能会对服务器存储造成一定的压力。</p></li> <li><p>SessionId 存储在 Cookie 中，而移动端对 Cookie 支持不是很好（部分手机浏览器可能会禁用掉 Cookie），所以移动端常用的是 Token，当然也可以选择把 SessionId 放在 url 后面。</p></li></ul> <h4 id="cookie-和-session-的区别"><a href="#cookie-和-session-的区别" class="header-anchor">#</a> Cookie 和 Session 的区别</h4> <ul><li>安全性：Session 比 Cookie 安全，Session 是存储在服务器端的，Cookie 是存储在客户端的（Session 只在客户端存储一个 SessionID，而 Cookie 把所有数据都存在了客户端）。</li> <li>存取值的类型不同：Cookie 只支持存储字符串数据，Session 可以存任意数据类型。</li> <li>存储大小不同：单个 Cookie 保存的数据不能超过 4K，Session 可存储数据远高于 Cookie，但是太多的 Session 会占用过多的服务器资源。</li> <li>有效期不同：Cookie 的有效期可以自行设置，Session 一般失效时间较短，客户端关闭（默认情况下）或者 Session 超时都会失效。</li></ul> <h2 id="token"><a href="#token" class="header-anchor">#</a> Token</h2> <h4 id="解决的问题"><a href="#解决的问题" class="header-anchor">#</a> 解决的问题</h4> <p>Session 扩展性不好，服务器集群之间难以共享。虽然可以将 Session 存在一个服务器中，其他服务器都向它请求 Session 数据，但这样容易造成单点失败，并且也不能很好达到负载均衡的效果。</p> <p>而 Token 选择将信息加密后存储在客户端，客户端下一次请求时带上这个 Token 给服务端验证即可。解决了 Session 扩展性不好的的问题，也减轻了服务端存储 Session 的压力。</p> <h4 id="token-的组成"><a href="#token-的组成" class="header-anchor">#</a> Token 的组成</h4> <ul><li>uid：用户唯一的身份标识。</li> <li>time：当前时间的时间戳。</li> <li>sign：签名，Token 的前几位以哈希算法压缩成的一定长度的十六进制字符串。</li> <li>还可以把其他的参数也放进 Token，避免多次查库。</li></ul> <h4 id="token-的特点"><a href="#token-的特点" class="header-anchor">#</a> Token 的特点</h4> <ul><li>无状态。服务器不需要存储相关信息，只需要验证 Token 即可。</li> <li>服务端无状态化、可扩展性好。</li> <li>支持移动端设备。</li> <li>安全。Token 有时效性，并且可以撤回使 Token 失效。</li> <li>支持跨程序调用。比如可以通过授权给出 Token，让第三方应用调用自己的 api。</li> <li>由应用管理，所以它可以避开同源策略。</li></ul> <h4 id="token-的认证过程"><a href="#token-的认证过程" class="header-anchor">#</a> Token 的认证过程</h4> <ol><li>客户端先通过账号密码等方式登录。</li> <li>验证通过后，服务端把用户信息通过加密算法和一个只有服务端知道的密钥，来生成一个字符串也就是 Token，并返回给客户端。</li> <li>客户端收到 Token 后将其存储在 Cookie 或 storage 里。</li> <li>客户端以后向服务器发送请求时都带上 Token（携放在 HTTP 请求头的 Authorization 字段里。或者放在 Cookie 里，当跨域的时候就放在 POST 请求的数据体里面）。</li> <li>服务端用相同的算法和密钥生成一个新的 Token，去比较验证这两个 Token，验证通过才执行后面的操作。</li></ol> <h4 id="token-和-ssession-的异同"><a href="#token-和-ssession-的异同" class="header-anchor">#</a> Token 和 Ssession 的异同</h4> <ul><li><p>Session 是一种记录服务器和客户端会话状态的机制，服务端是有状态的，可以记录会话信息。而 Token 是令牌，访问 API 时所需要的资源凭证。Token 使服务端无状态化，不会存储会话信息。</p></li> <li><p>作为身份认证，Token 安全性比 Session 好。 Session 的验证是基于 SessionID 的，只要请求方有了 SessionID 就认为它有了该用户的所有权利，即使 SessionID 被盗取服务端也不会进一步验证请求者身份。而 Token 不仅有签名而且验证是基于 Token 里的用户信息的，即使被盗取了中间人也无法获取相应的用户权限。</p></li></ul> <h2 id="jwt"><a href="#jwt" class="header-anchor">#</a> JWT</h2> <h4 id="jwt-组成"><a href="#jwt-组成" class="header-anchor">#</a> JWT 组成</h4> <ul><li>Header 头部：包括 Token 的类型比如是 JWT、使用的签名算法。</li> <li>Payload 负载：包括实际传送的数据，比如签发人、签发时间、有效时间、接收者等。也可以在这里定义额外的字段。</li> <li>Signature 签名：服务端使用只有服务端才知道的秘钥和 Header 里指明的签名算法，对前面两个部分进行加密，防止数据篡改。</li> <li>（上面三部分要使用 Base64URL 算法转成字符串，并且分别使用  <code>.</code> 隔开）。</li></ul> <h4 id="jwt-原理"><a href="#jwt-原理" class="header-anchor">#</a> JWT 原理</h4> <p>服务器认证以后，生成一个 JSON 对象（记录用户身份和有效期）返回给用户。以后用户与服务端通信的时候，都要发送这个 JSON 对象。服务器完全只靠这个对象认定用户身份。<strong>为了防止用户篡改数据，服务器在生成这个对象的时候会加上签名</strong>。</p> <h4 id="jwt-的几个特点"><a href="#jwt-的几个特点" class="header-anchor">#</a> JWT 的几个特点</h4> <ul><li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次（JWT 不加密的情况下，不能将秘密数据写入 JWT）。</li> <li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li> <li>JWT 的最大缺点是，由于服务器不保存 Session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</li> <li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li> <li>为了减少盗用，JWT 不应该使用 HTTP 协议明文传输，要使用 HTTPS 协议传输。</li></ul> <blockquote><p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener noreferrer">JSON Web Token 入门教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <blockquote><p><a href="https://juejin.im/post/6873700061000237069" target="_blank" rel="noopener noreferrer">使用NodeJS实现JWT原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h4 id="jwt-的缺点"><a href="#jwt-的缺点" class="header-anchor">#</a> JWT 的缺点</h4> <ul><li>由于服务器不需要存储 Token 信息的，所以中途无法废弃某个 Token 或者更改 Token 的权限。</li></ul> <h4 id="jwt-和-token-的异同"><a href="#jwt-和-token-的异同" class="header-anchor">#</a> JWT 和 Token 的异同</h4> <ul><li><p>相同点</p> <ul><li>都是访问资源的令牌。</li> <li>都可以记录用户的信息。</li> <li>都是使服务端无状态化。</li> <li>都是只有验证成功后，客户端才能访问服务端上受保护的资源。</li></ul></li> <li><p>不同点</p> <ul><li>Token：服务端验证客户端发送过来的 Token 时，还需要查询数据库获取用户信息（Token 可以存到 redis 中，服务端验证的时候需要查 redis 去比对 Token，而 JWT 不需要存到 redis），然后验证 Token 是否有效。</li> <li>JWT：将 Token 和 Payload 加密后存储于客户端，服务端只需要使用密钥解密进行校验即可，不需要查询或者减少查询数据库，因为 JWT 自包含了用户信息和加密的数据。</li></ul></li></ul> <h2 id="sso-单点登录"><a href="#sso-单点登录" class="header-anchor">#</a> SSO 单点登录</h2> <ul><li><p>CAS 中央认证服务，所有子系统的登录访问都由中央认证系统统一认证，认证成功后再颁发 token 给各个子系统，通过 token 来建立和子系统的会话。</p></li> <li><p><strong>登录原理</strong>：</p> <ul><li>用户访问系统 1 的受保护资源，系统 1 发现用户未登录，跳转至 SSO 认证中心，并将自己的地址作为参数。</li> <li>SSO 认证中心发现用户未登录，将用户引导至登录页面。</li> <li>用户输入用户名密码提交登录申请。</li> <li>SSO 认证中心校验用户信息，创建用户与 SSO 认证中心之间的会话，称为全局会话，同时创建授权令牌。</li> <li>SSO 认证中心带着令牌跳转回最初的请求地址（系统 1）。</li> <li>系统 1 拿到令牌，去 SSO 认证中心校验令牌是否有效。</li> <li>SSO 认证中心校验令牌，返回有效，注册系统 1。</li> <li>系统 1 使用该令牌创建与用户的会话，称为局部会话，返回受保护资源。</li> <li>用户访问系统 2 的受保护资源。</li> <li>系统 2 发现用户未登录，跳转至 SSO 认证中心，并将自己的地址作为参数。</li> <li>SSO 认证中心发现用户已登录，跳转回系统 2 的地址，并附上令牌。</li> <li>系统 2 拿到令牌，去 SSO 认证中心校验令牌是否有效。</li> <li>SSO 认证中心校验令牌，返回有效，注册系统 2。</li> <li>系统 2 使用该令牌创建与用户的局部会话，返回受保护资源。</li></ul></li></ul> <p><img src="/assets/img/5.f616b6e1.png" alt=""></p> <ul><li><p>全局会话与局部会话：</p> <ul><li>全局会话：用户与 SSO 认证中心建立的会话。</li> <li>局部会话：用户与各个子系统建立的会话。局部会话建立之后，用户访问子系统受保护资源将不再通过 SSO 认证中心。</li> <li>两者的约束关系：
<ul><li>局部会话存在，全局会话一定存在。</li> <li>全局会话存在，局部会话不一定存在。</li> <li>全局会话销毁，局部会话必须销毁。</li></ul></li></ul></li> <li><p><strong>注销原理</strong>：</p> <ul><li>用户向系统 1 发起注销请求。</li> <li>系统 1 根据用户与系统 1 建立的会话 id 拿到令牌，向 SSO 认证中心发起注销请求。</li> <li>SSO 认证中心校验令牌有效，销毁全局会话，同时取出所有用此令牌注册的系统地址。</li> <li>SSO 认证中心向所有注册系统发起注销请求。</li> <li>各注册系统接收 SSO 认证中心的注销请求，销毁局部会话。</li> <li>SSO 认证中心引导用户至登录页面。</li></ul></li></ul> <p><img src="/assets/img/6.b6acc4b7.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/JavaScript/OAuth.html" class="prev">
        OAuth
      </a></span> <span class="next"><a href="/JavaScript/网页性能.html">
        网页性能
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e38833ea.js" defer></script><script src="/assets/js/2.17cbeac6.js" defer></script><script src="/assets/js/12.a9bf3862.js" defer></script>
  </body>
</html>
