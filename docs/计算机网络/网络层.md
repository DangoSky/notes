# 网络层

![](./images/wangluoceng/1.png)

## IP 协议

- 路由器仅根据目的主机所连接的网络号来转发分组，从而减小了路由表中的项目数、路由表所占的存储空间和查找路由表的时间。

- 由于一个路由器至少应当连接到两个网络，因此一个路由器至少有两个不同的 IP 地址和硬件地址。 

- 在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的。 

- 多归属主机：一台主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号必须是不同的。

- 无名网络 / 无编号网络：当两个路由器直接相连时（例如通过一条租用线路），在连线两端的接口处，可以分配也可以不分配 IP 地址。

### IP 地址组成

- 组成： IP 地址 = 网络号 + 主机号。网络号识别唯一一个网络，主机号在它网络号所指明的网络范围内唯一。

- IP 地址使用 8 字节（IPV4）32 位（IPV6 则是 128 位）。

![](./images/wangluoceng/2.png)

### IP 地址分类

- A 类地址：共有 2^31 个地址，占整个 IP 地址空间的 50%。
  - 网络号：网络号占 1 字节（该字段的第 1 位已固定为 0，所以只有 7 位可用）。但可指派的网络号是 2^7 - 2 个(126)。 减 2 的原因是:
  
    - 网络号为 00000000 的 IP 地址是个保留地址，表示本网络。
    
    - 网络号为 01111111（127） 保留作为本地软件环回测试本主机的进程之间的通信。 若主机发送一个目的地址为环回地址（例如 127.0.0.1）的 IP 数据报， 则本主机中的协议软件就处理数据报中的数据，而不会把数据报发送到任何网络。目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。

  - 主机号占 3 个字节，因此每一个 A 类网络中的最大主机数是 2^24 — 2。 这里减 2 的原因是：
    
    - 全 0 的主机号表示该 IP 地址是本主机所连接到的单个网络地址(例如， 一主机的 IP 地址为 5.6.7.8, 则该主机所在的网络地址就是 5.0.0.0), 
    
    - 全 1 的主机号表示该网络上的所有主机。
  
- B 类地址

- C 类地址

![](./images/wangluoceng/5.png)


### IP 地址和 MAC 地址

![](./images/wangluoceng/3.png)

- 主机或路由器在收到 MAC 帧时，根据 MAC 帧首部中的 MAC 地址决定收下或丢弃该 MAC 帧。只有在剥去 MAC 帧的首部和尾部并把 MAC 层的数据上交给网络层后，网络层才能在 IP 数据报的首部中找到源 IP 地址和目的 IP 地址。

- 在不同网络上传送时，MAC 帧首部中的源地址和目的地址要发生变化。在数据链路层要丢弃原来的 MAC 帧的首部和尾部。转发时再重新添加上新的 MAC 帧的首部和尾部。

### ARP 地址解析协议

- 作用：根据 IP 地址查找其对应的 MAC 地址。

- 方法：在主机 ARP 高速缓存中存放一个从 IP 地址到硬件地址的映射表，并且这个映射表保持动态更新（新增或超时删除，每一个映射地址项目都设置了生存时间）。

- 如果在 ARP 高速缓存中没有找到相应的 MAC 地址映射，就在其所在的局域网上**广播**发送一个 ARP 请求分组（包括发送方自己的 IP 地址和 MAC 地址以及目的主机的 IP 地址）。局域网上其他主机都收到这个请求分组，如果自身的 IP 地址和查询的 IP 地址一致的话，目标主机就向发送方**单播**发送 ARP 响应分组，并将发送方的 IP 地址和 MAC 地址写入自己的  ARP 高速缓存。


### IP 数据报格式

![](./images/wangluoceng/4.png)

- 版本：使用的 IP 协议版本。

- 总长度：首部和数据部分的长度和。如果有分片的话，则指分片后的每一个分片的首部长度与该分片的数据长度和。

  - 若所传送的数据报长度超过数据链路层的 MTU 值，就必须把过长的数据报进行分片处理。

- 标识：标志每一个 IP 数据报，对于同一个数据报的分组它们的标识相同，方便各数据报分片最后能正确地重装成为原来的数据报。

- 标志：目前只有两位有意义。

  - 最低位记为 MF，MF 为 1 表示后面还有数据报分片，MF 为 O 表示这是最后一个数据报分片了。
  
  - 标志字段中间一位记为 DF，标识不能分片，只有当 DF 为 0 时才允许分片。

- 片偏移：相对于用户数据字段的起点，该分片从何处开始。片偏移以 8 个字节为偏移单位，即每个分片的长度一定是 8 字节(64位) 的整数倍。

- 生存时间：指明数据报在互联网中至多可经过多少个路由器，防止无法交付的数据报无限制地在互联网中兜圈子。

- 首部检验和：只检验数据报的首部，而不校验数据部分。 这是因为数据报每经过一个路由器，路由器都要重新计算一下首部检验和(一些字段如生存时间、标志、片偏移等都可能发生变化)。 

  - 校验方法： 在发送方，先把 IP 数据报首部划分为许多 16 位字的序列，并把检验和字段置零。用反码算术运算把所有 16 位字相加后，将得到的和的反码写入检验和字段。接收方收到数据报后，将首部的所有 16 位字再使用反码算术运算相加一次。将得到的和取反码，即得出接收方检验和的计算结果。若首部未发生任何变化，则此结果必为 0, 就保留这个数据报， 否则认为出了差错要将此数据报丢弃。


### IP 分组转发

- **特定主机路由**：对特定的目的主机指定一个路由。

- **默认路由**：指明分组转发的默认路由出口。

- 分组转发算法：

1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。 

2. 若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付，不需要再经过其他的路由器。直接把数据报交付目的主机，包括把目的主机地址 D 转换为具体的硬件地址，把数据报封装为 MAC 帧再发送此帧)。否则就是间接交付，执行步骤 3。

3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器。否则执行步骤 4。

4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器。否则执行步骤 5。

5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器。否则执行步骤 6。

6. 报告转发分组出错。



## 划分子网/子网寻址/子网路由选择

- 为什么要划分子网：原来的二级 IP 地址

  - IP 地址空间的利用率有时很低。

  - 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。

  - 两级 IP 不够灵活。

- 如何划分子网：从主机号借用若干位作为子网号（当然主机号也就相应减少了同样的位数），于是原来的两级 IP 地址在就变为三级 IP 地址。IP地址 = 网络号 + 子网号 + 主机号。

- 划分子网纯属一个单位内部的事情，本单位以外的网络看不见这个网络是由多少个子网组成，因为这个单位对外仍然表现为一个网络。


### 子网掩码

- 作用：用于获取一个 IP 地址的网络号。**将一个 IP 地址和它的子网掩码与运算，结果就是它的网络地址**（网络号 + 子网号）。即使不划分子网，使用子网掩码也能更便于查找路由表。

- 组成：通常使用连续的 1 表示网络号和子网号，连续的 0 表示主机号。（子网掩码使用连续的 1 是为了方便通过相与运算获取网络地址）。

- 默认子网掩码：默认子网掩码中 1 的位置和 IP 地址中的网络号字段正好相对应。这样用默认子网掩码和某个不划分子网的 IP 地址逐位相与，也能得到它的网络号，从而知道该地址的类别， 而不用再去查找该地址的类。

- 若一个网络的子网号位数是 n，则它的子网数是 2^n - 2（减去全 0 和全 1 两种情况）；每个子网的主机数是 2^(主机位数-n) - 2；

- 同样的 IP 地址和不同的子网掩码可以得出相同的网络地址。但是不同的子网掩码（取决于子网的位数）的效果是不同的。子网号位数越小，划分的子网数量就越少，每个子网上连接的主机数就越多。


### 使用子网时 IP 分组的转发

- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。因此路由器的路由表中的每一个项目，就包括了目的网络地址、下一跳地址、子网掩码。若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

- 在划分子网的情况下， 路由器转发分组的算法如下:

1. 从收到的数据报的首部提取目的 IP 地址 D。

2. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查: 用各网络的子网掩码和 D 逐位相与，看结果是否和相应的网络地址匹配。若匹配则把分组进行直接交付(当然还需要把 D 转换成物理地址，把数据报封装成帧发送出去)，转发任务结束。否则就是间接交付执行步骤 3。

3. 若路由表中有目的地址为 D 的特定主机路由， 则把数据报传送给路由表中所指明的下一跳路由器。否则执行步骤 4。

4. 对路由表中的每一行(目的网络地址，子网掩码，下一跳地址)，用其中的子网掩码和 D 逐位相与，其结果为N。若 N 与该行的目的网络地址匹配，则把数
据报传送给该行指明的下一跳路由器。否则执行步骤 5。

5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器。否则执行步骤 6。

6. 报告转发分组出错。


### 无分类编址 CIDR (构造超网)

- 作用：

  - 减少路由表中的项目数。

  - 通过减少网络前缀的位数（原先的按 A、B、C 分类地址，网络号位数被固定了限制了地址数的增加）来增加可分配的地址数。

- 特点：

  - 消除了传统的 A 类、B 类和 C 类地址以及划分子网的的概念，因而能更加有效地分配 1Pv4 的地址空间。

  - 将 32 位的 IP 地址划分为前后两个部分。IP 地址 = 网络前缀 + 主机号（无分类的两级编址）。使用斜线记法（CIDR 记法），在 IP 地址后面加上斜线 /，后面写上网络前缀所占的位数。

- 地址掩码：由一串 1 和一串 0 组成，而 1 的个数就是网络前缀的长度。
 
- CIDR 并没有在 32 位地址中指明若干位作为子网字段。 但分配到一个 CIDR 地址块的单位仍然可以在本单位内根据需要划分出一些子 网，这些子网也都只有一个网络前缀和一台主机号字段，但子网的网络前缀比整个单位的网络前缀长些。

- 路由聚合 / 构成超网：在路由表中就利用 CIDR 地址块（网络前缀都相同的连续的 IP 地址）来查找目的网络。有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

- CIDR 的其他记法：

  - 省略点分十进制中低位连续的 0，地址块 10.0.0.0/10 可简写为 10/10。
  
  - 在网络前缀的后面加一个星号 *，如 00001010 00*。表示在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值。

- **最长前缀匹配**：使用 CIDR 后，路由表中每个项目变成了由网络前缀和下一条地址组成，但这样在查找路由表时可能会得到多个匹配结果。应当从匹配结果中选择具有最长网络前缀的路由，这是因为网络前缀越长，其地址块就越小，路由也就越具体。


## 网际控制报文协议 ICMP

- 作用：允许主机或路由器报告差错情况和提供有关异常情况的报告。

- 应用：

  - 分组网间探测 ping：用来测试两台主机之间的连通性。ping 使用了 ICMP 回送请求与回送回答报文。ping 是应用层直接使用网络层 ICMP 的一个例子，它没有通过运输层的 TCP 或 UDP。

  - tarcerotue / tarcetr：用来跟踪一个分组从源点到终点的路径。

#### ICMP 报文格式

![](./images/wangluoceng/6.png)

- ICMP 报文就是 IP 数据报的数据部分。

- 校验和：用来检验整个 ICMP 报文。IP 数据报首部的检验和并不检验 IP 数据报的数据部分，所以不能保证经过传输的 ICMP 报文不产生差错。

- ICMP 报文的种类和相关类型。


![](./images/wangluoceng/7.png)

