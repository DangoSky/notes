# 应用层

## 域名系统 DNS

- 处理 IP 数据报时为什么不直接使用域名：

  - IP 地址的长度是固定的 32 位或 128 位，而域名的长度并不是固定的。

  - 机器更适合于处理数字。

- DNS 请求报文使用 UDP。

### 域名结构

- 级别最低的域名写在最左边，而级别最高的顶级域名则写在最右边。例如 dangosky.com 是 二级域名.顶级域名的结构。

- 由多个标号组成的完整域名总共不超过 255 个字符。 

- 各级域名由其上一级的域名管理机构管理。

### 域名服务器

- 区：一个服务器所负责管辖的范围，一个区中的所有节点必须是能够连通的。DNS 服务器的管辖范围以区为单位，域 ≥ 区。

![](./images/yingyongceng/1.png)

- 四种域名服务器：

  - 根域名服务器：最高层次的域名服务器，所有根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址。

    - 根域名服务器采用了**任播**技术，因此当 DNS 客户向某个根域名服务器的 IP 地址发出查询报文时，互联网上的路由器就能找到离这个 DNS 客户最近的一个根域名服务器。这样做不仅加快了 DNS 的查询过程，也更加合理地利用了互联网的资源。

    - 在许多情况下，根域名服务器并不直接把待查询的域名直接转换成 IP 地址（根域名服务器也没有存放这种信息），而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。

  - 顶级域名服务器：负责管理在该顶级域名服务器注册的所有二级域名。

  - 权限域名服务器：用来保存该区中的所有主机的域名到 IP 地址的映射。当一个权限域名服务器不能给出最后的查询回答时，就会告诉发出查询请求的 DNS 客户，下一步应当找哪一个权限域名服务器。

  - 本地域名服务器 / 默认域名服务器：当一台主机发出 DNS 查询请求时，这个查询请求报文会首先发送给本地域名服务器。

- 为了提高域名服务器的可靠性，DNS 域名服务器都把数据复制到几个域名服务器来保存，其中一个是主域名服务器，其他的都是辅助域名服务器。当主域名服务器出故障时，辅助域名服务器可以保证 DNS 的查询工作不会中断。主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行，这样就保证了数据的一致性。


### 域名解析过程

- 递归查询和迭代查询：

  - 递归查询：一般是主机向本地域名服务器的查询。如果主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身份向其他根域名服务器继续发出查询请求报文，而不是让该主机自已进行下一步的查询。因此，递归查询返回的查询结果或者是所要查询的IP地址，或者是报错表示无法查询到所需的 IP 地址。（帮你查询完毕后直接告诉你目标的 IP 地址）

  - 迭代查询：一般是本地域名服务器向根域名服务器的查询。当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地域名服务器下一步应当向哪一个域名服务器进行查询，而不是替本地域名服务器进行后续的查询。（只告诉你下一步要向哪个域名服务器查询）

![](./images/yingyongceng/2.png)

- 高速缓存：

  - 为了提高 DNS 查询效率，并减轻根域名服务器的负荷和减少互联网上的 DNS 查询报文数量，在域名服务器中广泛地使用了高速缓存。高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录，比如对应的顶级域名服务器或权限域名服务器的 IP 地址，这样就可以直接向相应的域名服务器查询了而不用按部就班一个个域名服务器查询过去。

  - 主机也使用高速缓存，维护存放自己最近使用的域名，只有在从缓存中找不到时才使用域名服务器。

  - 高速缓存的每项内容都设置一个计时器，到期后需要重新查询。


**查询过程总结**

应用进程发起解析 -> 主机高速缓存 -> 发 DNS 请求报文给本地域名服务器 -> 根域名服务器 -> 顶级域名服务器 -> 权限域名服务器（查询域名服务器前都先看自身有没有缓存）。


## 动态主机配置协议 DHCP

- 即插即用连网。自动配置计算机的 IP 地址、子网掩码、默认路由器的 IP 地址和域名服务器的 IP 地址等。

- 需要 IP 地址的主机在启动时就向 DHCP 服务器广播发送发现报文（将目的 IP 地址置为 255.255.255.255)。发送广播报文是因为现在还不知道 DHCP 服务器在什么地方，因此要发现 DHCP 服务器的 IP 地址。这台主机目前还没有自己的 IP 地址，因此将 IP 数据报的源 IP 地址设为全 0。这样在本地网络上的所有主机都能够收到这个广播报文，但只有 DHCP 服务器才对此广播报文进行回答。DHCP 服务器先在其数据库中查找该计算机的配置信息。若找到的话则返回找到的信息。否则从服务器的 IP 地址池中取一个地址分配给该计算机。

- 为了避免在每一个网络上都设置一个 DHCP 服务器，因此使每一个网络至少有一个 DHCP 中继代理（通常是一台路由器），它配置了 DHCP 服务器的 IP 地址信息。当 DHCP 中继代理收到主机以广播形式发送的发现报文后，就以单播方式向 DHCP 服务器转发此报文并等待其回答。收到 DHCP 服务器回答的提供报文后，DHCP 中继代理再把此提供报文发回给请求主机（DHCP 报文使用 UDP）。

![](./images/yingyongceng/3.png)


## HTTP

- 使用 HTTP/1.0 请求一个万维网文档所需的时间是：该文档的传输时间（与文档大小成正比）+ 2 * RTT (一个 RTT 用于建立 TCP 连接，另一个 RTT 用于请求和接收万维网文档。第三次握手时可以把 HTTP 请求报文做为报文数据发送给服务器）。

- HTTP/1.1 使用长连接可以保持浏览器和该服务器的连接。HTTP/1.1 有两种工作方式：

  - 非流水线方式：浏览器在收到前一个响应后才能发出下一个请求。

  - 流水线方式：浏览器在收到 HTTP 的响应报文之前就能够接着发送新的请求报文。


### 请求报文

![](./images/yingyongceng/4.jpg)

- 仅有 POST、PUT、PATCH 这三种方法的请求报文会包含请求体，GET、HEAD、DELETE、CONNECT、TRACE、OPTIONS 都不包含请求体。

#### 请求头

- Date：请求发送的日期和时间。

- User-Agent：包含发出请求的用户信息，例如 User-Agent: Mozilla/5.0 (Linux; X11)。

- Accept：浏览器能够接受的响应类型，如纯文本数据或图片。

- Accept-Charset：浏览器可接受的字符集。

- Content-Length：表示请求消息正文的长度。对于 POST 请求来说，必须携带 Content-Length 请求头。

- Host：访问的主机名。Host 指定请求资源的 Intenet 主机和端口号，表示请求 url 的原始服务器或网关的位置。HTTP/1.1 请求必须包含主机头域，否则系统会以 400 状态码返回。

- If-Modified-Since：告诉服务器资源的缓存时间。如果请求的部分在指定时间之后被修改则请求成功，未被修改则返回 304 Not Modified 应答。

- If-None-Match：如果内容未改变返回 304，参数为服务器先前发送的 Etag，与服务器回应的 Etag 比较判断是否改变。

- Expires：设置绝对缓存时间，时间字符串。（使用于 http1.0）

- Cache-Control：设置相对缓存时间，max-age。（使用于 http1.1，优先级比 Expires 高）

  - public：为所有用户都设置缓存。
  - private：只为单个用户缓存。
  - no-cache：使用缓存前线校验缓存是否过期。
  - no-store：不使用缓存。
  - must-revalidate: 缓存过期时必须检验（针对客户端有时候可以使用过期缓存）。

- Referer：值为一个 URL，告诉服务器它是从哪个连接来访问当前的请求页面的。

- Connection：处理完这次请求后是否断开连接还是继续保持连接。如果值为 Keep-Alive 或者使用的是 HTTP 1.1，则会开启长连接。

- Range：请求指定范围内的数据。可以用于下载等。

- Pragma：形式唯一为 Pragma: no-cache。只用在客户端发送的请求中，要求所有中间服务器不返回缓存的资源。



### 响应报文

![](./images/yingyongceng/5.jpg)

#### 响应头

- Date：响应的时间。

- ETag：标志请求的服务端资源是否发生了变化。

- Set-Cookie：设置客户端的 Cookie。

- Allow：服务器支持哪些请求方法。

- Content-Type：表示后面的文档属于什么 MIME 类型。Servlet 默认为 text/plain，但通常需要显式地指定为 text/html。

- Expires：告诉浏览器把回送的资源缓存多长时间，-1 或 0 则是不缓存。

- Last-Modified：文档的最后改动时间（和请求报文中的 If-Modified-Since 联系起来）。

- Location：配合 302 状态码使用，用于重定向到一个新 URI 地址。


### 状态码

#### 1xx

信息性状态码，表示服务器已接收了客户端请求，客户端可继续发送请求。

#### 2xx

成功状态码，表示服务器已成功接收到请求并进行处理。

- 200 OK：请求被正常处理。
  
- 204 No Content：表示请求已成功处理但是没有内容返回。
  
- 206：服务器已经成功处理了部分 GET 请求（范围性请求）。类似于迅雷这类的 HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。该请求必须包含 Range 头信息来指示客户端希望得到的内容范围，响应报文中包括 content-range 指定范围的实体内容。

#### 3xx

重定向。

- 301 Moved Permanently：永久重定向。资源已经被分配了新的 URI。新的 URI 应该提示在响应报文的 Location 首部字段。搜索引擎在抓取新内容的同时也将旧的网址替换为重定向之后的网址。

- 302 Found：临时重定向。请求的资源暂时被配到到了新的 URI。新的临时 URI 应该提示在响应报文的 Location 首部字段。常用于在 404 页面跳转到首页或未登录用户跳转到登陆页面。搜索引擎会抓取新的内容而保留旧的网址。

- 304 Not Modified：请求的资源未修改，服务器返回此状态码时不会返回任何资源（联系起浏览器缓存，强缓存和协商缓存）。

- 307 Temporary Redirect：临时重定向。302 禁止 POST 变为 GET，但并没有被严格遵守。而 307 就会遵照标准，不会从 POST 变为 GET，但各个浏览器的处理响应行为可能不同。

#### 4xx

客户端错误。

- 400 Bad Request：客户端请求的语法错误，服务器无法理解。

- 401 Unauthorized：请求要求用户的身份认证。

- 403 Forbidden：服务器理解请求客户端的请求，但是拒绝执行此请求，比如没有权限。

- 404 Not Found：服务器找不到请求的资源。

#### 5xx

服务端错误。

- 500 Internal Server Error：服务器执行请求的时候出错了，可能是 Web 应用有 bug 或临时事故。

- 503 Service Unavailable：由于超载或系统维护，服务器暂时的无法处理客户端的请求。如果服务器知道还需要多长时间，就将服务器 Retry-After 首部字段返回。

- 505 HTTP Version not supported：服务器不支持请求的 HTTP 协议的版本，无法完成处理。


### GET 和 POST 的区别

- 语义上的区别，GET 用于获取数据，POST 用于提交数据。

- GET 的请求参数会加在 URL 之后，而 POST 则把请求参数放在 HTTP 的请求体中。因此又有：

  - GET 历史参数保留在浏览器历史中。POST 参数不会保存在浏览器历史和服务器日志中。

  - 安全性问题。但这安全性只是相对的。htpp 本身就是明文传输，只要通过抓包还是能获取数据报文。

  - 然而 HTTP 没有要求 POST 的请求参数一定要放到请求体里面，GET 就一定要放到 URL 里面，只是规定如此而已。如果服务器支持的话，也可以反过来使用 POST 在 URL 中写参数。

- GET 的请求参数有长度限制，而 POST 无限制。

  - HTTP 协议并没有对 HTTP 请求头和请求体有长度限制，只是受限于 URL 长度（具体的数值取决于浏览器和服务器的限制）。这是因为避免处理超长的 URL 造成服务器负担和恶意的攻击如 XSS。

- GET 后退按钮/刷新无害，POST 数据会被重新提交（浏览器应该告知用户数据会被重新提交）。

- GET 产生一个 TCP 数据包，POST 产生两个 TCP 数据包。

  - 对于 GET 方式的请求，浏览器会把请求头和请求体一并发送出去，服务器响应 200。而对于 POST，浏览器先发送请求头，服务器响应 100 后再发送请求体，服务器响应 200。但这只是部分浏览器的请求实现，不属于 POST 的必然行为。

- 对数据类型的限制：GET 只允许用 ASCII 字符，POST 则没有限制，可以用二进制数据。在编码类型上：GET 编码类型 `application/x-www-form-url`，POST 编码类型 `encodedapplication/x-www-form-urlencoded` 或 `multipart/form-data`。为二进制数据使用多重编码。

- GET 书签可收藏，POST 为书签不可收藏。

- GET 能被缓存，POST 不能缓存。

### 幂等

- 幂等是指同一个请求方法执行多次和仅执行一次的效果完全相同。

- 按照 RFC 规范，PUT、DELETE 等方法都是幂等的。虽说是规范，但服务端实现是否幂等是无法确保的。

- 引入幂等主要是为了处理同一个请求重复发送的情况，比如在请求响应前失去连接，如果方法是幂等的就可以放心地重发一次请求。这也是浏览器在后退和刷新时遇到 POST 会给用户提示的原因，POST 不是幂等的，重复请求可能会带来意想不到的后果。


